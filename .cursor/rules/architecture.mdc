# FocusExpo Architecture Rules

You are an AI assistant helping to build FocusExpo, a React Native focus management app for iOS.

## ‚ö†Ô∏è Important: Documentation Organization

**Please DO NOT automatically create new Markdown documents.**

This project organizes documentation as follows:
- üìå **CLAUDE.md** (root) - Auto-loaded by Claude Code, DO NOT modify structure
- üìå **This file** (.cursor/rules/) - Auto-applied by Cursor IDE, DO NOT modify structure
- üìÇ **docs/** - All other documentation goes here

**Only create new Markdown files if the user explicitly requests it.**

## System Knowledge

You understand that FocusExpo has:
- **13 Zustand Stores** for state management (usePlanStore, useUserStore, useRecordStore, etc)
- **3-tier storage**: MMKV (L1), AsyncStorage (L2), SharedGroupPreferences (L3)
- **iOS native integration** for Screen Time API and app blocking
- **Expo Router v5** for file-based routing
- **NativeWind** for Tailwind CSS styling
- **PostHog** for analytics

## Code Style Rules

### React & TypeScript
- ‚ùå NO: `useEffect + useCallback` combinations (causes infinite loops)
- ‚úÖ YES: Inline event handlers or useMemo
- Always use explicit TypeScript types
- No `any` types - use `unknown` if needed
- Declare dependency arrays explicitly

### Component Organization
```
src/components/
‚îú‚îÄ‚îÄ ui/           # Reusable components
‚îú‚îÄ‚îÄ home/         # Home screen components
‚îú‚îÄ‚îÄ business/     # Business logic components
‚îú‚îÄ‚îÄ modals/       # Modal/dialog components
‚îî‚îÄ‚îÄ system/       # System components
```

### File Naming
- Components: PascalCase (FocusTimer.tsx)
- Files: kebab-case (focus-timer.ts)
- Functions: camelCase (startFocusTimer)
- Constants: SCREAMING_SNAKE_CASE
- Stores: camelCase (plan.ts ‚Üí usePlanStore)

## Store Patterns

### Creating a Store
```typescript
import { create } from 'zustand';
import { combine } from 'zustand/middleware';

export const useFeatureStore = create(
  combine(
    { state: initialValue },
    (set, get) => ({
      // Methods and operations
      async initData() {
        const data = await request.get('/api');
        set({ state: data });
      },
      // Cross-store communication
      async operation() {
        const other = useOtherStore.getState();
        await other.method();
      }
    })
  )
);
```

### Using Store Selectors
```typescript
// Single property (optimized)
const activePlan = usePlanStore(s => s.activePlan);

// Multiple properties
const { plans, loading } = usePlanStore(s => ({
  plans: s.plans,
  loading: s.loading
}));
```

## iOS Native Integration

### Calling Native Methods
```typescript
// src/native/ios/methods.ts - Always async
import { Methods } from '@/native/ios/methods';

async function startFocus() {
  try {
    const result = await Methods.startAppLimits(60, 'plan-id');
    Toast.show('Focus started');
  } catch (error) {
    Toast.show(error.message, 'error');
    console.error('Start focus error:', error);
  }
}
```

### Listening to Native Events
```typescript
// src/native/ios/events.ts
import { createFocusStateListener } from '@/native/ios/events';

useEffect(() => {
  const subscription = createFocusStateListener((event) => {
    if (event.state === 'ended') {
      handleFocusEnded();
    }
  });
  return () => subscription.remove();
}, []);
```

## Storage Rules

### When to Use Each Storage
| Storage | Use Case | Access Time |
|---------|----------|------------|
| MMKV | Plans, records, frequent data | <100ms |
| AsyncStorage | User info, tokens, settings | <200ms |
| SharedGroupPreferences | Data for Extensions | iOS App Groups |

### Storage Example
```typescript
// MMKV - High frequency
import { storage } from '@/utils/storage';
storage.set('plans', JSON.stringify(plans));
const cached = JSON.parse(storage.getString('plans') || '[]');

// AsyncStorage - Low frequency
import AsyncStorage from '@react-native-async-storage/async-storage';
await AsyncStorage.setItem('user_token', token);
const token = await AsyncStorage.getItem('user_token');

// App Groups
storage.setGroup('shield_data', JSON.stringify(data));
```

## API & Network Rules

### HTTP Requests
```typescript
// All requests use centralized request instance
import { request } from '@/utils/request';

// Get
const { data } = await request.get('/plan/lists', {
  params: { page: 1 }
});

// Post
await request.post('/plan/add', { name: 'Focus' });

// Patch
await request.patch(`/plan/${id}`, { updated_at: now });

// Delete
await request.delete(`/plan/${id}`);

// Errors are automatically handled:
// - 401: Token cleared, redirect to login
// - 4xx/5xx: Toast shown, error logged
// - Network: Auto-retry with exponential backoff
```

## Performance Rules

### Rendering
- Use selector pattern: `usePlanStore(s => s.activePlan)`
- Use `useMemo` for expensive computations
- Use `StyleSheet.create()` for static styles
- Use `FlatList` with `keyExtractor` for lists

### Anti-Patterns
```typescript
// ‚ùå AVOID
const style = { padding: 10 };  // New object every render
const filtered = plans.filter(p => p.active);  // New array every render
useCallback(() => {}, []);  // Usually unnecessary

// ‚úÖ PREFER
const style = useMemo(() => ({ padding: 10 }), []);
const filtered = usePlanStore(s => s.plans.filter(p => p.active));
const handleClick = () => { /* inline handler */ };
```

## Common Tasks

### Add New Screen
1. Create `app/folder/screen.tsx`
2. Import Store: `import { useFeatureStore } from '@/stores'`
3. Use components from `src/components/ui/`
4. Expo Router auto-generates routes

### Add New Store
1. Create `src/stores/feature.ts` with combine pattern
2. Export in `src/stores/index.ts`
3. Add init() method for app startup
4. Use getState() for cross-store communication

### Call iOS Native Code
1. Use existing methods in `src/native/ios/methods.ts`
2. Or add new method following same pattern
3. Always handle errors with try/catch
4. Show Toast for user feedback

### Add API Integration
1. Add endpoint call in Store
2. Use centralized `request` from `src/utils/request.ts`
3. Errors automatically handled
4. Add PostHog tracking for analytics

## Debugging

### Common Issues

**Metro bundler stuck:**
```bash
watchman watch-del-all
rm -rf node_modules/.cache
expo start -c
```

**Type errors:**
```bash
expo lint
```

**iOS permission issues:**
- Check `src/utils/permission.ts`
- Verify Xcode entitlements
- Request permission before using

**Timer accuracy:**
- Use chain timers, not setInterval
- See `src/native/ios/sync.ts`

## Key Files Reference

| File | Purpose |
|------|---------|
| `app/_layout.tsx` | Root layout, providers, init |
| `src/stores/` | All state management |
| `src/native/ios/` | iOS bridge layer |
| `src/components/ui/` | Base UI components |
| `src/utils/request.ts` | HTTP client |
| `src/config/theme.ts` | Theme system |
| `CLAUDE.md` | Full project guide |
| `ARCHITECTURE.md` | Deep architecture docs |

## When Uncertain

1. Check `CLAUDE.md` for quick reference
2. Check `ARCHITECTURE.md` for details
3. Look at similar existing code
4. Keep it simple, avoid over-engineering
5. Ask for clarification on unclear requirements

## Package Manager

‚ö†Ô∏è **Important:** Use **Bun**, NOT npm or yarn

```bash
bun install
bun add package-name
bun run script-name
```

---

**Last Updated:** January 2026
**Project:** FocusExpo v1.0+
